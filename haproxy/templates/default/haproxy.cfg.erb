<%= render "haproxy.cfg.globals.erb" %>

<% if node[:opsworks][:layers][:nginxphpapp][:instances].empty? -%>
    <%= render "haproxy.cfg.fallback.erb" %>
<% else -%>
    <%= render "haproxy.cfg.backend.erb", :variables => {
        'layername' => 'nginxphpapp',
        'instances' => node[:opsworks][:layers][:nginxphpapp][:instances],
        'haproxy' => node[:haproxy]
    } %>
<% end -%>

<%= render "haproxy.cfg.frontend.erb", :variables => {
    'opsworkslayers' => node[:opsworks][:layers],
    'haproxy' => node[:haproxy]
} %>